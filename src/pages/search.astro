---
import SearchResults from '../components/search/SearchResults.tsx';
import SubPageNav from '../components/navigation/sub-page-nav.astro';
import GlobalLayout from '../layouts/global-layout.astro';

const allPosts = import.meta.glob('./posts/*.{md,mdx}', { eager: true });

const posts = Object.entries(allPosts)
    .map(([path, post]: [string, any]) => {
        const slug =
            path
                .split('/')
                .pop()
                ?.replace(/\.(md|mdx)$/, '') || '';

        let description = '';
        let content = '';
        if (post.rawContent && typeof post.rawContent === 'function') {
            content = post.rawContent();
        } else if (post.body) {
            content = post.body;
        } else if (
            post.compiledContent &&
            typeof post.compiledContent === 'function'
        ) {
            content = post.compiledContent();
        }

        if (content) {
            const lines = content.split('\n');
            for (const line of lines) {
                const trimmed = line.trim();
                if (
                    trimmed &&
                    !trimmed.startsWith('#') &&
                    !trimmed.startsWith('---') &&
                    !trimmed.startsWith('!') &&
                    !trimmed.startsWith('import ') &&
                    !trimmed.startsWith('<')
                ) {
                    description = trimmed
                        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                        .replace(/\*\*([^*]+)\*\*/g, '$1')
                        .replace(/\*([^*]+)\*/g, '$1')
                        .replace(/`([^`]+)`/g, '$1')
                        .replace(/!\[([^\]]*)\]\([^)]+\)/g, '$1')
                        .replace(/<[^>]+>/g, '')
                        .replace(/\s+/g, ' ')
                        .trim()
                        .substring(0, 150);
                    break;
                }
            }
        }

        if (!description) {
            description = `Read about ${post.frontmatter?.title || 'this post'} on Mat Loughnane's blog.`;
        }

        return {
            title: post.frontmatter?.title || '',
            image: post.frontmatter?.image || '',
            categories: post.frontmatter?.categories || [],
            slug: `/posts/${slug}`,
            description,
            learnMore: post.frontmatter?.learn_more || '',
        };
    })
    .filter((post) => post.title);
---

<GlobalLayout
    title="Search"
    description="Search posts on Mat Loughnane's blog."
>
    <SubPageNav />
    <section class="py-8 px-8">
        <div class="max-w-7xl mx-auto">
            <SearchResults client:only="react" posts={posts} />
        </div>
    </section>
</GlobalLayout>
